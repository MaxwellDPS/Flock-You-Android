name: Android CI/CD

on:
  # Build on push to main branch
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  
  # Build on pull requests
  pull_request:
    branches: [ main, master ]
  
  # Manual trigger with release option
  workflow_dispatch:
    inputs:
      create_release:
        description: 'ğŸ“¦ Create a GitHub Release'
        required: true
        type: boolean
        default: false
      release_version:
        description: 'ğŸ·ï¸ Release version (e.g., 1.0.0)'
        required: false
        type: string
        default: ''
      pre_release:
        description: 'ğŸ§ª Mark as pre-release'
        required: false
        type: boolean
        default: false
      release_notes:
        description: 'ğŸ“ Release notes (optional)'
        required: false
        type: string
        default: ''

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ===========================================
  # Build Job - Always runs
  # ===========================================
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    
    outputs:
      version_name: ${{ steps.version.outputs.version_name }}
      version_code: ${{ steps.version.outputs.version_code }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'
      
      - name: ğŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: ğŸ“ Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: ğŸ·ï¸ Extract version info
        id: version
        run: |
          # Extract version from build.gradle.kts
          VERSION_NAME=$(grep -oP 'versionName\s*=\s*"\K[^"]+' app/build.gradle.kts || echo "1.0.0")
          VERSION_CODE=$(grep -oP 'versionCode\s*=\s*\K\d+' app/build.gradle.kts || echo "1")
          
          # Use input version if provided for release
          if [ -n "${{ inputs.release_version }}" ]; then
            VERSION_NAME="${{ inputs.release_version }}"
          fi
          
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: $VERSION_NAME ($VERSION_CODE)"
      
      - name: ğŸ§¹ Clean project
        run: ./gradlew clean
      
      - name: ğŸ”¨ Build Debug APK
        run: ./gradlew assembleDebug --stacktrace
      
      - name: ğŸ“¤ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 14

  # ===========================================
  # Release Build Job - Only when release is requested
  # ===========================================
  build-release:
    name: ğŸš€ Build Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && inputs.create_release == true
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'
      
      - name: ğŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: ğŸ“ Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: ğŸ” Decode Keystore
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > app/release-keystore.jks
          echo "âœ… Keystore decoded"
      
      - name: ğŸ”¨ Build Release APK (Signed)
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=${{ github.workspace }}/app/release-keystore.jks \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
            --stacktrace
      
      - name: ğŸ”¨ Build Release APK (Unsigned)
        if: env.KEYSTORE_BASE64 == ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "âš ï¸ No keystore configured, building unsigned APK"
          ./gradlew assembleRelease --stacktrace
      
      - name: ğŸ“ Rename APK with version
        run: |
          VERSION="${{ needs.build.outputs.version_name }}"
          if [ -z "$VERSION" ]; then
            VERSION="${{ inputs.release_version }}"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
          fi
          
          # Find and rename the APK
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$APK_PATH" ]; then
            mv "$APK_PATH" "app/build/outputs/apk/release/FlockYou-v${VERSION}.apk"
            echo "ğŸ“¦ Renamed APK to FlockYou-v${VERSION}.apk"
          fi
      
      - name: ğŸ“¤ Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90
      
      - name: ğŸ§¹ Cleanup keystore
        if: always()
        run: rm -f app/release-keystore.jks

  # ===========================================
  # Create GitHub Release
  # ===========================================
  release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: [build, build-release]
    if: github.event_name == 'workflow_dispatch' && inputs.create_release == true
    
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Release APK
        uses: actions/download-artifact@v4
        with:
          name: app-release
          path: release-apk
      
      - name: ğŸ·ï¸ Determine version
        id: version
        run: |
          if [ -n "${{ inputs.release_version }}" ]; then
            VERSION="${{ inputs.release_version }}"
          else
            VERSION="${{ needs.build.outputs.version_name }}"
          fi
          
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Release version: $VERSION"
      
      - name: ğŸ“ Generate Release Notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Start with custom notes if provided
          if [ -n "${{ inputs.release_notes }}" ]; then
            NOTES="${{ inputs.release_notes }}"
            NOTES="$NOTES"$'\n\n'
          else
            NOTES=""
          fi
          
          # Add standard release info
          NOTES="$NOTES## ğŸ“± Flock You v$VERSION"$'\n\n'
          NOTES="$NOTES### Features"$'\n'
          NOTES="$NOTES- ğŸ“¡ WiFi and Bluetooth LE surveillance device detection"$'\n'
          NOTES="$NOTES- ğŸ¯ Flock Safety, Penguin, Pigvision, and Raven device detection"$'\n'
          NOTES="$NOTES- ğŸ—ºï¸ Map view with detection locations"$'\n'
          NOTES="$NOTES- ğŸ”” Real-time alerts with vibration"$'\n'
          NOTES="$NOTES- ğŸ“Š Detection history and filtering"$'\n\n'
          NOTES="$NOTES### Installation"$'\n'
          NOTES="$NOTES1. Download the APK file below"$'\n'
          NOTES="$NOTES2. Enable \"Install from unknown sources\" in Android settings"$'\n'
          NOTES="$NOTES3. Open the APK to install"$'\n\n'
          NOTES="$NOTES### Requirements"$'\n'
          NOTES="$NOTES- Android 8.0 (API 26) or higher"$'\n'
          NOTES="$NOTES- Location permissions for scanning"$'\n'
          NOTES="$NOTES- Bluetooth permissions for BLE detection"$'\n\n'
          NOTES="$NOTES---"$'\n'
          NOTES="$NOTES*Based on [colonelpanichacks/flock-you](https://github.com/colonelpanichacks/flock-you)*"
          
          # Save to file to handle multiline
          echo "$NOTES" > release_notes.md
          echo "Generated release notes"
      
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Flock You ${{ steps.version.outputs.tag }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ inputs.pre_release }}
          files: |
            release-apk/*.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: âœ… Release Summary
        run: |
          echo "## ğŸ‰ Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ inputs.pre_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -la release-apk/ >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # Lint & Test Job (runs in parallel)
  # ===========================================
  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'
      
      - name: ğŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: ğŸ“ Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: ğŸ” Run Lint
        run: ./gradlew lint --stacktrace
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Lint Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-results
          path: app/build/reports/lint-results-*.html
          retention-days: 7

  # ===========================================
  # Unit Tests
  # ===========================================
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'gradle'
      
      - name: ğŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: ğŸ“ Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: ğŸ§ª Run Unit Tests
        run: ./gradlew testDebugUnitTest --stacktrace
        continue-on-error: true
      
      - name: ğŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: app/build/reports/tests/
          retention-days: 7
